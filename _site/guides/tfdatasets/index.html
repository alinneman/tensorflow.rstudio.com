<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>TensorFlow for R - Build TensorFlow input pipelines</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../guides/deploy/index.html" rel="next">
<link href="../../guides/tfautograph/index.html" rel="prev">
<link href="../../images/favicon/icon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <img src="../../images/favicon/icon.png" alt="">
    <span class="navbar-title">TensorFlow for R</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../install/">Install</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/">Tutorials</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../guides/">Guides</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../examples/">Examples</a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reference" role="button" data-bs-toggle="dropdown" aria-expanded="false">Reference</a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-reference">    
        <li>
    <a class="dropdown-item" href="../../reference/tensorflow/index.html">
 <span class="dropdown-text">tensorlow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/keras/index.html">
 <span class="dropdown-text">keras</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/tfdatasets/index.html">
 <span class="dropdown-text">tfdatasets</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/tfautograph/index.html">
 <span class="dropdown-text">tfautograph</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/tfhub/index.html">
 <span class="dropdown-text">tfhub</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Build TensorFlow input pipelines</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/index.html" class="sidebar-item-text sidebar-link">Guides</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Tensorflow Basics</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tensorflow/basics.html" class="sidebar-item-text sidebar-link">Overview</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tensorflow/tensor.html" class="sidebar-item-text sidebar-link">Tensors</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tensorflow/variable.html" class="sidebar-item-text sidebar-link">Variables</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tensorflow/autodiff.html" class="sidebar-item-text sidebar-link">Automatic differentiation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tensorflow/intro_to_graphs.html" class="sidebar-item-text sidebar-link">Graphs and functions</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Keras</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/sequential_model.html" class="sidebar-item-text sidebar-link">The Sequential model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/functional_api.html" class="sidebar-item-text sidebar-link">The Functional API</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/training_with_built_in_methods.html" class="sidebar-item-text sidebar-link">Training &amp; evaluation with the built-in methods</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/making_new_layers_and_models_via_subclassing.html" class="sidebar-item-text sidebar-link">Making custom layer and model objects.</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/serialization_and_saving.html" class="sidebar-item-text sidebar-link">Serialization and saving</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/preprocessing_layers.html" class="sidebar-item-text sidebar-link">Working with preprocessing layers</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/customizing_what_happens_in_fit.html" class="sidebar-item-text sidebar-link">Customizing what happens in <code>fit()</code></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/writing_a_training_loop_from_scratch.html" class="sidebar-item-text sidebar-link">Writing a training loop from scratch</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/working_with_rnns.html" class="sidebar-item-text sidebar-link">Working with RNNs</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/understanding_masking_and_padding.html" class="sidebar-item-text sidebar-link">Understanding masking &amp; padding</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/writing_your_own_callbacks.html" class="sidebar-item-text sidebar-link">Writing your own callbacks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/keras/transfer_learning.html" class="sidebar-item-text sidebar-link">Transfer learning and fine-tuning</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">TensorFlow in depth</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tensorflow/tensor_slicing.html" class="sidebar-item-text sidebar-link">Tensor Slicing</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tfautograph/index.html" class="sidebar-item-text sidebar-link">Autograph</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Data input pipelines</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/tfdatasets/index.html" class="sidebar-item-text sidebar-link active">Build TensorFlow input pipelines</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../guides/deploy/index.html" class="sidebar-item-text sidebar-link">Deployment</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/deploy/plumber.html" class="sidebar-item-text sidebar-link">Plumber API</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/deploy/shiny.html" class="sidebar-item-text sidebar-link">Deploying a Shiny app with a TensorFlow model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../guides/deploy/docker.html" class="sidebar-item-text sidebar-link">TensorFlow serving</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#basic-mechanics" id="toc-basic-mechanics" class="nav-link active" data-scroll-target="#basic-mechanics">Basic mechanics</a>
  <ul class="collapse">
  <li><a href="#dataset-structure" id="toc-dataset-structure" class="nav-link" data-scroll-target="#dataset-structure">Dataset structure</a></li>
  </ul></li>
  <li><a href="#reading-input-data" id="toc-reading-input-data" class="nav-link" data-scroll-target="#reading-input-data">Reading input data</a>
  <ul class="collapse">
  <li><a href="#consuming-r-arrays" id="toc-consuming-r-arrays" class="nav-link" data-scroll-target="#consuming-r-arrays">Consuming R arrays</a></li>
  <li><a href="#consuming-tfrecord-data" id="toc-consuming-tfrecord-data" class="nav-link" data-scroll-target="#consuming-tfrecord-data">Consuming TFRecord data</a></li>
  <li><a href="#consuming-text-data" id="toc-consuming-text-data" class="nav-link" data-scroll-target="#consuming-text-data">Consuming text data</a></li>
  <li><a href="#consuming-csv-data" id="toc-consuming-csv-data" class="nav-link" data-scroll-target="#consuming-csv-data">Consuming CSV data</a></li>
  <li><a href="#consuming-sets-of-files" id="toc-consuming-sets-of-files" class="nav-link" data-scroll-target="#consuming-sets-of-files">Consuming sets of files</a></li>
  </ul></li>
  <li><a href="#batching-dataset-elements" id="toc-batching-dataset-elements" class="nav-link" data-scroll-target="#batching-dataset-elements">Batching dataset elements</a>
  <ul class="collapse">
  <li><a href="#simple-batching" id="toc-simple-batching" class="nav-link" data-scroll-target="#simple-batching">Simple batching</a></li>
  <li><a href="#batching-tensors-with-padding" id="toc-batching-tensors-with-padding" class="nav-link" data-scroll-target="#batching-tensors-with-padding">Batching tensors with padding</a></li>
  </ul></li>
  <li><a href="#training-workflows" id="toc-training-workflows" class="nav-link" data-scroll-target="#training-workflows">Training workflows</a>
  <ul class="collapse">
  <li><a href="#processing-multiple-epochs" id="toc-processing-multiple-epochs" class="nav-link" data-scroll-target="#processing-multiple-epochs">Processing multiple epochs</a></li>
  <li><a href="#randomly-shuffling-input-data" id="toc-randomly-shuffling-input-data" class="nav-link" data-scroll-target="#randomly-shuffling-input-data">Randomly shuffling input data</a></li>
  </ul></li>
  <li><a href="#preprocessing-data" id="toc-preprocessing-data" class="nav-link" data-scroll-target="#preprocessing-data">Preprocessing data</a>
  <ul class="collapse">
  <li><a href="#decoding-image-data-and-resizing-it" id="toc-decoding-image-data-and-resizing-it" class="nav-link" data-scroll-target="#decoding-image-data-and-resizing-it">Decoding image data and resizing it</a></li>
  <li><a href="#parsing-tfexample-protocol-buffer-messages" id="toc-parsing-tfexample-protocol-buffer-messages" class="nav-link" data-scroll-target="#parsing-tfexample-protocol-buffer-messages">Parsing <code>tf$Example</code> protocol buffer messages</a></li>
  <li><a href="#time-series-windowing" id="toc-time-series-windowing" class="nav-link" data-scroll-target="#time-series-windowing">Time series windowing</a></li>
  <li><a href="#resampling" id="toc-resampling" class="nav-link" data-scroll-target="#resampling">Resampling</a></li>
  </ul></li>
  <li><a href="#iterator-checkpointing" id="toc-iterator-checkpointing" class="nav-link" data-scroll-target="#iterator-checkpointing">Iterator Checkpointing</a></li>
  <li><a href="#using-tfdatasets-with-keras" id="toc-using-tfdatasets-with-keras" class="nav-link" data-scroll-target="#using-tfdatasets-with-keras">Using tfdatasets with Keras</a></li>
  <li><a href="#environment-details" id="toc-environment-details" class="nav-link" data-scroll-target="#environment-details">Environment Details</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/t-kalinowski/tf-site/edit/main/guides/tfdatasets/index.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/t-kalinowski/tf-site/blob/main/guides/tfdatasets/index.qmd" class="toc-action">View source</a></p><p><a href="https://github.com/t-kalinowski/tf-site/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Build TensorFlow input pipelines</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>The tfdatasets API enables you to build complex input pipelines from simple, reusable pieces. For example, the pipeline for an image model might aggregate data from files in a distributed file system, apply random perturbations to each image, and merge randomly selected images into a batch for training. The pipeline for a text model might involve extracting symbols from raw text data, converting them to embedding identifiers with a lookup table, and batching together sequences of different lengths. The <code>tf$data</code> API makes it possible to handle large amounts of data, read from different data formats, and perform complex transformations.</p>
<p>The tfdatasets API introduces a TensorFlow Dataset abstraction that represents a sequence of elements, in which each element consists of one or more components. For example, in an image pipeline, an element might be a single training example, with a pair of tensor components representing the image and its label.</p>
<p>There are two distinct ways to create a dataset:</p>
<ul>
<li>A data <strong>source</strong> constructs a <code>Dataset</code> from data stored in memory or in one or more files.</li>
<li>A data <strong>transformation</strong> constructs a dataset from one or more <code>Dataset</code> objects.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tensorflow)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tfdatasets)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(keras)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="basic-mechanics" class="level2">
<h2 class="anchored" data-anchor-id="basic-mechanics">Basic mechanics</h2>
<p>To create an input pipeline, you must start with a data <em>source</em>. For example, to construct a <code>Dataset</code> from data in memory, you can use <code>tensors_dataset()</code> or <code>tensor_slices_dataset()</code>. Alternatively, if your input data is stored in a file in the recommended TFRecord format, you can use <code>tfrecord_dataset()</code>.</p>
<p>Once you have a <code>Dataset</code> object, you can <em>transform</em> it into a new <code>Dataset</code> by chaining method calls on the <code>Dataset</code> object. For example, you can apply per-element transformations such as <code>dataset_map()</code>, and multi-element transformations such as <code>dataset_batch()</code>. See the documentation for <code>tfdatasets</code> for a complete list of transformations.</p>
<p>The <code>Dataset</code> object is a iterable. This makes it possible to consume its elements using a the <code>coro::loop</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">8</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loaded Tensorflow version 2.9.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TensorSliceDataset element_spec=TensorSpec(shape=(), dtype=tf.float32, name=None)&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span>(elem <span class="cf">in</span> dataset) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">as.numeric</span>(elem))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8
[1] 3
[1] 0
[1] 8
[1] 2
[1] 1</code></pre>
</div>
</div>
<p>Or by explicitly creating a Python iterator using <code>iter</code> and consuming its elements using <code>next</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>it <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>(dataset)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(reticulate<span class="sc">::</span><span class="fu">iter_next</span>(it))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(8.0, shape=(), dtype=float32)</code></pre>
</div>
</div>
<p>Alternatively, dataset elements can be consumed using the <code>reduce</code> transformation, which reduces all elements to produce a single result. The following example illustrates how to use the <code>reduce</code> transformation to compute the sum of a dataset of integers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_reduce</span>(<span class="dv">0</span>, <span class="cf">function</span>(state, value) state <span class="sc">+</span> value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(22.0, shape=(), dtype=float32)</code></pre>
</div>
</div>
<section id="dataset-structure" class="level3">
<h3 class="anchored" data-anchor-id="dataset-structure">Dataset structure</h3>
<p>A dataset produces a sequence of <em>elements</em>, where each element is the same (nested) structure of <em>components</em>. Individual components of the structure can be of any type representable by <code>tf$TypeSpec</code>, including <code>tf$Tensor</code>, <code>tf$sparse$SparseTensor</code>, <code>tf$RaggedTensor</code>, <code>tf$TensorArray</code>, or <code>tf$data$Dataset</code>.</p>
<p>The constructs that can be used to express the (nested) structure of elements include <code>tuple</code>, <code>dict</code>, <code>NamedTuple</code>, and <code>OrderedDict</code>. In particular, <code>list</code> is not a valid construct for expressing the structure of dataset elements. This is because early tfdataset users felt strongly about <code>list</code> inputs (e.g.&nbsp;passed to <code>tensors_dataset()</code>) being automatically packed as tensors and <code>list</code> outputs (e.g.&nbsp;return values of user-defined functions) being coerced into a <code>tuple</code>. As a consequence, if you would like a <code>list</code> input to be treated as a structure, you need to convert it into <code>tuple</code> and if you would like a <code>list</code> output to be a single component, then you need to explicitly pack it using <code>tf$stack</code>.</p>
<p>The <code>dataset_element_spec</code> property allows you to inspect the type of each element component. The property returns a <em>nested structure</em> of <code>tf$TypeSpec</code> objects, matching the structure of the element, which may be a single component, a tuple of components, or a nested tuple of components. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dataset1 <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(<span class="fu">shape</span>(<span class="dv">4</span>, <span class="dv">10</span>)))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dataset1<span class="sc">$</span>element_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorSpec(shape=(10,), dtype=tf.float32, name=None)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(reticulate<span class="sc">::</span><span class="fu">tuple</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(<span class="fu">shape</span>(<span class="dv">4</span>)),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(<span class="fu">shape</span>(<span class="dv">4</span>, <span class="dv">100</span>), <span class="at">maxval =</span> 100L, <span class="at">dtype =</span> tf<span class="sc">$</span>int32)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>dataset2<span class="sc">$</span>element_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
TensorSpec(shape=(), dtype=tf.float32, name=None)

[[2]]
TensorSpec(shape=(100,), dtype=tf.int32, name=None)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dataset3 <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(dataset1, dataset2)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dataset3<span class="sc">$</span>element_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
TensorSpec(shape=(10,), dtype=tf.float32, name=None)

[[2]]
[[2]][[1]]
TensorSpec(shape=(), dtype=tf.float32, name=None)

[[2]][[2]]
TensorSpec(shape=(100,), dtype=tf.int32, name=None)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset containing a sparse tensor.</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sparse <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">SparseTensor</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">indices =</span> <span class="fu">list</span>(<span class="fu">c</span>(0L,0L), <span class="fu">c</span>(1L,2L)), </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dense_shape =</span> <span class="fu">shape</span>(<span class="dv">3</span>,<span class="dv">4</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>dataset4 <span class="ot">&lt;-</span> <span class="fu">tensors_dataset</span>(sparse)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>dataset4<span class="sc">$</span>element_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparseTensorSpec(TensorShape([3, 4]), tf.float32)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use value_type to see the type of value represented by the element spec</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>dataset4<span class="sc">$</span>element_spec<span class="sc">$</span>value_type</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'tensorflow.python.framework.sparse_tensor.SparseTensor'&gt;</code></pre>
</div>
</div>
<p>The <code>Dataset</code> transformations support datasets of any structure. When using the <code>dataset_map()</code>, and <code>dataset_filter()</code> transformations, which apply a function to each element, the element structure determines the arguments of the function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>dataset1 <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(<span class="fu">shape</span>(<span class="dv">4</span>, <span class="dv">10</span>), <span class="at">minval =</span> 1L, <span class="at">maxval =</span> 10L, <span class="at">dtype =</span> tf<span class="sc">$</span>int32))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>dataset1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TensorSliceDataset element_spec=TensorSpec(shape=(10,), dtype=tf.int32, name=None)&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>dataset1 <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor([2 5 5 1 1 8 5 6 2 5], shape=(10), dtype=int32)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dataset2 <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(reticulate<span class="sc">::</span><span class="fu">tuple</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(<span class="fu">shape</span>(<span class="dv">4</span>)),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span>random<span class="sc">$</span><span class="fu">uniform</span>(<span class="fu">shape</span>(<span class="dv">4</span>, <span class="dv">100</span>), <span class="at">maxval =</span> 100L, <span class="at">dtype =</span> tf<span class="sc">$</span>int32)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>dataset2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TensorSliceDataset element_spec=(TensorSpec(shape=(), dtype=tf.float32, name=None), TensorSpec(shape=(100,), dtype=tf.int32, name=None))&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dataset3 <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(dataset1, dataset2)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>dataset3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ZipDataset element_spec=(TensorSpec(shape=(10,), dtype=tf.int32, name=None), (TensorSpec(shape=(), dtype=tf.float32, name=None), TensorSpec(shape=(100,), dtype=tf.int32, name=None)))&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dataset3 <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ :&lt;tf.Tensor: shape=(10), dtype=int32, numpy=array([2, 5, 5, 1, 1, 8, 5, 6, 2, 5], dtype=int32)&gt;
 $ :List of 2
  ..$ :&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.5500927&gt;
  ..$ :&lt;tf.Tensor: shape=(100), dtype=int32, numpy=…&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="reading-input-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-input-data">Reading input data</h2>
<section id="consuming-r-arrays" class="level3">
<h3 class="anchored" data-anchor-id="consuming-r-arrays">Consuming R arrays</h3>
<p>See <a href="../tutorials/load_data/numpy.qmd">Loading NumPy arrays</a> for more examples.</p>
<p>If all of your input data fits in memory, the simplest way to create a <code>Dataset</code> from them is to convert them to <code>tf$Tensor</code> objects and use <code>tensor_slices_dataset()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(train, test) <span class="sc">%&lt;-%</span> <span class="fu">dataset_fashion_mnist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>train[[<span class="dv">1</span>]][] <span class="ot">&lt;-</span> train[[<span class="dv">1</span>]]<span class="sc">/</span><span class="dv">255</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(train)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TensorSliceDataset element_spec={'x': TensorSpec(shape=(28, 28), dtype=tf.float64, name=None), 'y': TensorSpec(shape=(), dtype=tf.int32, name=None)}&gt;</code></pre>
</div>
</div>
<p>Note: The above code snippet will embed the <code>features</code> and <code>labels</code> arrays in your TensorFlow graph as <code>tf$constant()</code> operations. This works well for a small dataset, but wastes memory—because the contents of the array will be copied multiple times—and can run into the 2GB limit for the <code>tf$GraphDef</code> protocol buffer.</p>
<!-- ### Consuming Python generators -->
<!-- Another common data source that can easily be ingested as a `tf$data$Dataset` is the python generator. -->
<!-- Caution: While this is a convienient approach it has limited portability and scalibility. It must run in the same python process that created the generator, and is still subject to the Python [GIL](https://en.wikipedia.org/wiki/Global_interpreter_lock). -->
<!-- ```{r} -->
<!-- count <- function(stop) {    } -->
<!--   i <- 0 -->
<!--   while i<stop: -->
<!--     yield i -->
<!--     i += 1 -->
<!-- ``` -->
<!-- ```{r} -->
<!-- for n in count(5): -->
<!--   print(n) -->
<!-- ``` -->
<!-- The `dataset_from_generator` constructor converts the python generator to a fully functional `tf$data$Dataset`. -->
<!-- The constructor takes a callable as input, not an iterator. This allows it to restart the generator when it reaches the end. It takes an optional `args` argument, which is passed as the callable's arguments. -->
<!-- The `output_types` argument is required because `tf$data` builds a `tf$Graph` internally, and graph edges require a `tf$dtype`. -->
<!-- ```{r} -->
<!-- ds_counter <- tf$data$dataset_from_generator(count, args = [25], output_types = tf$int32, output_shapes = (), ) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- for count_batch in ds_counter$repeat().batch(10).take(10): -->
<!--   print(count_batch$numpy()) -->
<!-- ``` -->
<!-- The `output_shapes` argument is not *required* but is highly recommended as many TensorFlow operations do not support tensors with an unknown rank. If the length of a particular axis is unknown or variable, set it as `NULL` in the `output_shapes`. -->
<!-- It's also important to note that the `output_shapes` and `output_types` follow the same nesting rules as other dataset methods. -->
<!-- Here is an example generator that demonstrates both aspects, it returns tuples of arrays, where the second array is a vector with unknown length. -->
<!-- ```{r} -->
<!-- gen_series <- function() {    } -->
<!--   i <- 0 -->
<!--   while TRUE: -->
<!--     size <- np$random$randint(0, 10) -->
<!--     yield i, np$random$normal(size = (size,)) -->
<!--     i += 1 -->
<!-- ``` -->
<!-- ```{r} -->
<!-- for i, series in gen_series(): -->
<!--   print(i, ":", str(series)) -->
<!--   if i > 5: -->
<!--     break -->
<!-- ``` -->
<!-- The first output is an `int32` the second is a `float32`. -->
<!-- The first item is a scalar, shape `()`, and the second is a vector of unknown length, shape `(NULL,)`  -->
<!-- ```{r} -->
<!-- ds_series <- tf$data$dataset_from_generator( -->
<!--     gen_series,  -->
<!--     output_types <- (tf$int32, tf$float32),  -->
<!--     output_shapes <- ((), (NULL,))) -->
<!-- ds_series -->
<!-- ``` -->
<!-- Now it can be used like a regular `tf$data$Dataset`. Note that when batching a dataset with a variable shape, you need to use `dataset_padded_batch`. -->
<!-- ```{r} -->
<!-- ds_series_batch <- ds_series$shuffle(20).padded_batch(10) -->
<!-- ids, sequence_batch = next(iter(ds_series_batch)) -->
<!-- print(ids$numpy()) -->
<!-- print() -->
<!-- print(sequence_batch$numpy()) -->
<!-- ``` -->
<!-- For a more realistic example, try wrapping `preprocessing$image$ImageDataGenerator` as a `tf$data$Dataset`. -->
<!-- First download the data: -->
<!-- ```{r} -->
<!-- flowers <- tf$keras$utils$get_file( -->
<!--     'flower_photos', -->
<!--     'https://storage$googleapis.com/download$tensorflow.org/example_images/flower_photos$tgz', -->
<!--     untar <- TRUE) -->
<!-- ``` -->
<!-- Create the `image$ImageDataGenerator` -->
<!-- ```{r} -->
<!-- img_gen <- tf$keras$preprocessing$image$ImageDataGenerator(rescale = 1./255, rotation_range = 20) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- images, labels = next(img_gen$flow_from_directory(flowers)) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- print(images$dtype, images$shape) -->
<!-- print(labels$dtype, labels$shape) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- ds <- tf$data$dataset_from_generator( -->
<!--     lambda: img_gen$flow_from_directory(flowers),  -->
<!--     output_types <- (tf$float32, tf$float32),  -->
<!--     output_shapes <- ([32,256,256,3], [32,5]) -->
<!-- ) -->
<!-- ds$element_spec -->
<!-- ``` -->
<!-- ```{r} -->
<!-- for images, labels in ds$take(1): -->
<!--   print('images$shape: ', images$shape) -->
<!--   print('labels$shape: ', labels$shape) -->
<!-- ``` -->
</section>
<section id="consuming-tfrecord-data" class="level3">
<h3 class="anchored" data-anchor-id="consuming-tfrecord-data">Consuming TFRecord data</h3>
<p>See <a href="../tutorials/load_data/tfrecord.qmd">Loading TFRecords</a> for an end-to-end example.</p>
<p>The tfdatasets API supports a variety of file formats so that you can process large datasets that do not fit in memory. For example, the TFRecord file format is a simple record-oriented binary format that many TensorFlow applications use for training data. The <code>tfrecord_dataset()</code> class enables you to stream over the contents of one or more TFRecord files as part of an input pipeline.</p>
<p>Here is an example using the test file from the French Street Name Signs (FSNS).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a dataset that reads all of the examples from two files.</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>fsns_test_file <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fsns.tfrec"</span>, </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://storage.googleapis.com/download.tensorflow.org/data/fsns-20160927/testdata/fsns-00000-of-00001"</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>filenames</code> argument to the <code>tfrecord_dataset()</code> initializer can either be a string, a list of strings, or a <code>tf$Tensor</code> of strings. Therefore if you have two sets of files for training and validation purposes, you can create a factory method that produces the dataset, taking filenames as an input argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">tfrecord_dataset</span>(<span class="at">filenames =</span> <span class="fu">list</span>(fsns_test_file))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TFRecordDatasetV2 element_spec=TensorSpec(shape=(), dtype=tf.string, name=None)&gt;</code></pre>
</div>
</div>
<p>Many TensorFlow projects use serialized <code>tf$train$Example</code> records in their TFRecord files. These need to be decoded before they can be inspected:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>raw_example <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>()</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>parsed <span class="ot">&lt;-</span> tf<span class="sc">$</span>train<span class="sc">$</span>Example<span class="sc">$</span><span class="fu">FromString</span>(raw_example<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>parsed<span class="sc">$</span>features<span class="sc">$</span>feature[<span class="st">'image/text'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bytes_list {
  value: "Rue Perreyon"
}</code></pre>
</div>
</div>
</section>
<section id="consuming-text-data" class="level3">
<h3 class="anchored" data-anchor-id="consuming-text-data">Consuming text data</h3>
<p>See <a href="../tutorials/load_data/text.qmd">Loading Text</a> for an end to end example.</p>
<p>Many datasets are distributed as one or more text files. The <code>text_line_dataset()</code> provides an easy way to extract lines from one or more text files. Given one or more filenames, a <code>text_line_dataset()</code> will produce one string-valued element per line of those files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>directory_url <span class="ot">&lt;-</span> <span class="st">'https://storage.googleapis.com/download.tensorflow.org/data/illiad/'</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>file_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'cowper.txt'</span>, <span class="st">'derby.txt'</span>, <span class="st">'butler.txt'</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>file_paths <span class="ot">&lt;-</span> <span class="fu">lapply</span>(file_names, <span class="cf">function</span>(file_name) {</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">get_file</span>(file_name, <span class="fu">paste0</span>(directory_url, file_name)) </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">text_line_dataset</span>(file_paths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the first few lines of the first file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b"\xef\xbb\xbfAchilles sing, O Goddess! Peleus' son;"&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'His wrath pernicious, who ten thousand woes'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b"Caused to Achaia's host, sent many a soul"&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'Illustrious into Ades premature,'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'And Heroes gave (so stood the will of Jove)'&gt;</code></pre>
</div>
</div>
<p>To alternate lines between files use <code>dataset_interleave()</code>. This makes it easier to shuffle files together. Here are the first, second and third lines from each translation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>files_ds <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(<span class="fu">unlist</span>(file_paths))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>lines_ds <span class="ot">&lt;-</span> files_ds <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_interleave</span>(text_line_dataset, <span class="at">cycle_length =</span> <span class="dv">3</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>lines_ds <span class="sc">%&gt;%</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">9</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 9
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b"\xef\xbb\xbfAchilles sing, O Goddess! Peleus' son;"&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b"\xef\xbb\xbfOf Peleus' son, Achilles, sing, O Muse,"&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'\xef\xbb\xbfSing, O goddess, the anger of Achilles son of Peleus, that brought'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'His wrath pernicious, who ten thousand woes'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'The vengeance, deep and deadly; whence to Greece'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'countless ills upon the Achaeans. Many a brave soul did it send'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b"Caused to Achaia's host, sent many a soul"&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'Unnumbered ills arose; which many a soul'&gt;
  [list output truncated]</code></pre>
</div>
</div>
<p>By default, a <code>text_line_dataset()</code> yields <em>every</em> line of each file, which may not be desirable, for example, if the file starts with a header line, or contains comments. These lines can be removed using the <code>dataset_skip()</code> or <code>dataset_filter()</code> transformations. Here, you skip the first line, then filter to find only survivors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>titanic_file <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"train.csv"</span>, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://storage.googleapis.com/tf-datasets/titanic/train.csv"</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>titanic_lines <span class="ot">&lt;-</span> <span class="fu">text_line_dataset</span>(titanic_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>titanic_lines <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'survived,sex,age,n_siblings_spouses,parch,fare,class,deck,embark_town,alone'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'0,male,22.0,1,0,7.25,Third,unknown,Southampton,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,38.0,1,0,71.2833,First,C,Cherbourg,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,26.0,0,0,7.925,Third,unknown,Southampton,y'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,35.0,1,0,53.1,First,C,Southampton,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'0,male,28.0,0,0,8.4583,Third,unknown,Queenstown,y'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'0,male,2.0,3,1,21.075,Third,unknown,Southampton,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,27.0,0,2,11.1333,Third,unknown,Southampton,n'&gt;
  [list output truncated]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>survived <span class="ot">&lt;-</span> <span class="cf">function</span>(line) {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  tf<span class="sc">$</span><span class="fu">not_equal</span>(tf<span class="sc">$</span>strings<span class="sc">$</span><span class="fu">substr</span>(line, 0L, 1L), <span class="st">"0"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>survivors <span class="ot">&lt;-</span> titanic_lines <span class="sc">%&gt;%</span> </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_skip</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_filter</span>(survived)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>survivors <span class="sc">%&gt;%</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,38.0,1,0,71.2833,First,C,Cherbourg,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,26.0,0,0,7.925,Third,unknown,Southampton,y'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,35.0,1,0,53.1,First,C,Southampton,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,27.0,0,2,11.1333,Third,unknown,Southampton,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,14.0,1,0,30.0708,Second,unknown,Cherbourg,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,4.0,1,1,16.7,Third,G,Southampton,n'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,male,28.0,0,0,13.0,Second,unknown,Southampton,y'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'1,female,28.0,0,0,7.225,Third,unknown,Cherbourg,y'&gt;
  [list output truncated]</code></pre>
</div>
</div>
</section>
<section id="consuming-csv-data" class="level3">
<h3 class="anchored" data-anchor-id="consuming-csv-data">Consuming CSV data</h3>
<p>See <a href="../tutorials/load_data/csv.qmd">Loading CSV Files</a>, and <a href="../tutorials/load_data/pandas_dataframe.qmd">Loading Data Frames</a> for more examples.</p>
<p>The CSV file format is a popular format for storing tabular data in plain text.</p>
<p>For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>titanic_file <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"train.csv"</span>, </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://storage.googleapis.com/tf-datasets/titanic/train.csv"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(titanic_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 627 Columns: 10
── Column specification ────────────────────────────────────────────────────
Delimiter: ","
chr (5): sex, class, deck, embark_town, alone
dbl (5): survived, age, n_siblings_spouses, parch, fare

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
  survived sex      age n_siblings_spou… parch  fare class deck  embark_town
     &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      
1        0 male      22                1     0  7.25 Third unkn… Southampton
2        1 female    38                1     0 71.3  First C     Cherbourg  
3        1 female    26                0     0  7.92 Third unkn… Southampton
4        1 female    35                1     0 53.1  First C     Southampton
5        0 male      28                0     0  8.46 Third unkn… Queenstown 
6        0 male       2                3     1 21.1  Third unkn… Southampton
# … with 1 more variable: alone &lt;chr&gt;</code></pre>
</div>
</div>
<p>If your data fits in memory the same <code>tensor_slices_dataset()</code> method works on lists, allowing this data to be easily imported:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>titanic_slices <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(df)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>titanic_slices <span class="sc">%&gt;%</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ survived          :&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.0&gt;
 $ sex               :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'male'&gt;
 $ age               :&lt;tf.Tensor: shape=(), dtype=float32, numpy=22.0&gt;
 $ n_siblings_spouses:&lt;tf.Tensor: shape=(), dtype=float32, numpy=1.0&gt;
 $ parch             :&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.0&gt;
 $ fare              :&lt;tf.Tensor: shape=(), dtype=float32, numpy=7.25&gt;
 $ class             :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'Third'&gt;
 $ deck              :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'unknown'&gt;
  [list output truncated]</code></pre>
</div>
</div>
<p>A more scalable approach is to load from disk as necessary.</p>
<p>The tfdatasets package provides methods to extract records from one or more CSV files that comply with <a href="https://tools.ietf.org/html/rfc4180">RFC 4180</a>.</p>
<p>The <code>experimental$make_csv_dataset</code> function is the high level interface for reading sets of csv files. It supports column type inference and many other features, like batching and shuffling, to make usage simple.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>titanic_batches <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">make_csv_dataset</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  titanic_file, </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> 4L,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_name =</span> <span class="st">"survived"</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>titanic_batches <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ :OrderedDict([('sex', &lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b'male', b'male', b'male', b'male'], dtype=object)&gt;), ('age', &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([40., 32., 59., 30.], dtype=float32)&gt;), ('n_siblings_spouses', &lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([0, 0, 0, 0], dtype=int32)&gt;), ('parch', &lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([0, 0, 0, 0], dtype=int32)&gt;), ('fare', &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([ 0.    ,  7.8542,  7.25  , 13.    ], dtype=float32)&gt;), ('class', &lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b'First', b'Third', b'Third', b'Second'], dtype=object)&gt;), ('deck', &lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b'B', b'unknown', b'unknown', b'unknown'], dtype=object)&gt;), ('embark_town', &lt;tf.Tensor: shape=(4,), dtype=string, numpy=
array([b'Southampton', b'Southampton', b'Southampton', b'Southampton'],
      dtype=object)&gt;), ('alone', &lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b'y', b'y', b'y', b'y'], dtype=object)&gt;)])
 $ :&lt;tf.Tensor: shape=(4), dtype=int32, numpy=array([0, 1, 0, 0], dtype=int32)&gt;</code></pre>
</div>
</div>
<p>You can use the <code>select_columns</code> argument if you only need a subset of columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>titanic_batches <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">make_csv_dataset</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  titanic_file, </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> 4L,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_name =</span> <span class="st">"survived"</span>, </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">select_columns =</span> <span class="fu">c</span>(<span class="st">'class'</span>, <span class="st">'fare'</span>, <span class="st">'survived'</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>titanic_batches <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ :OrderedDict([('fare', &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([ 7.75, 69.55, 15.9 ,  8.05], dtype=float32)&gt;), ('class', &lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b'Third', b'Third', b'Third', b'Third'], dtype=object)&gt;)])
 $ :&lt;tf.Tensor: shape=(4), dtype=int32, numpy=array([0, 0, 1, 1], dtype=int32)&gt;</code></pre>
</div>
</div>
<p>There is also a lower-level <code>tf$experimental$CsvDataset</code> class which provides finer grained control. It does not support column type inference. Instead you must specify the type of each column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>titanic_types  <span class="ot">=</span> <span class="fu">list</span>(tf<span class="sc">$</span>int32, tf<span class="sc">$</span>string, tf<span class="sc">$</span>float32, tf<span class="sc">$</span>int32, tf<span class="sc">$</span>int32, tf<span class="sc">$</span>float32, tf<span class="sc">$</span>string, tf<span class="sc">$</span>string, tf<span class="sc">$</span>string, tf<span class="sc">$</span>string)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">CsvDataset</span>(titanic_file, titanic_types , <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">%&gt;%</span> </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :&lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'male'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=float32, numpy=22.0&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=int32, numpy=1&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=float32, numpy=7.25&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'Third'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'unknown'&gt;
  [list output truncated]</code></pre>
</div>
</div>
<p>If some columns are empty, this low-level interface allows you to provide default values instead of column types.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="at">con =</span> <span class="st">"missing.csv"</span>, <span class="at">text =</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="st">"1,2,3,4</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="st">,2,3,4</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="st">1,,3,4</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="st">1,2,,4</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="st">1,2,3,</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="st">,,,"</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a dataset that reads all of the records from two CSV files, each with</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># four float columns which may have missing values.</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>record_defaults <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">999</span>,<span class="dv">999</span>,<span class="dv">999</span>,<span class="dv">999</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">CsvDataset</span>(<span class="st">"missing.csv"</span>, record_defaults)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(...) tf<span class="sc">$</span><span class="fu">stack</span>(<span class="fu">list</span>(...)))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MapDataset element_spec=TensorSpec(shape=(4,), dtype=tf.float32, name=None)&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 6
 $ :&lt;tf.Tensor: shape=(4), dtype=float32, numpy=array([1., 2., 3., 4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(4), dtype=float32, numpy=array([999.,   2.,   3.,   4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(4), dtype=float32, numpy=array([  1., 999.,   3.,   4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(4), dtype=float32, numpy=array([  1.,   2., 999.,   4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(4), dtype=float32, numpy=array([  1.,   2.,   3., 999.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(4), dtype=float32, numpy=array([999., 999., 999., 999.], dtype=float32)&gt;</code></pre>
</div>
</div>
<p>By default, a <code>CsvDataset</code> yields <em>every</em> column of <em>every</em> line of the file, which may not be desirable, for example if the file starts with a header line that should be ignored, or if some columns are not required in the input. These lines and fields can be removed with the <code>header</code> and <code>select_cols</code> arguments respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a dataset that reads all of the records from two CSV files with</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># headers, extracting float data from columns 2 and 4.</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>record_defaults <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">999</span>, <span class="dv">999</span>) <span class="co"># Only provide defaults for the selected columns</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">CsvDataset</span>(</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"missing.csv"</span>, </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  record_defaults, </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">select_cols =</span> <span class="fu">c</span>(1L, 3L)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(...) tf<span class="sc">$</span><span class="fu">stack</span>(<span class="fu">list</span>(...)))</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MapDataset element_spec=TensorSpec(shape=(2,), dtype=tf.float32, name=None)&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 6
 $ :&lt;tf.Tensor: shape=(2), dtype=float32, numpy=array([2., 4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(2), dtype=float32, numpy=array([2., 4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(2), dtype=float32, numpy=array([999.,   4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(2), dtype=float32, numpy=array([2., 4.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(2), dtype=float32, numpy=array([  2., 999.], dtype=float32)&gt;
 $ :&lt;tf.Tensor: shape=(2), dtype=float32, numpy=array([999., 999.], dtype=float32)&gt;</code></pre>
</div>
</div>
</section>
<section id="consuming-sets-of-files" class="level3">
<h3 class="anchored" data-anchor-id="consuming-sets-of-files">Consuming sets of files</h3>
<p>There are many datasets distributed as a set of files, where each file is an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>flowers_root <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'flower_photos'</span>,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz'</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">untar =</span> <span class="cn">TRUE</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: these images are licensed CC-BY, see LICENSE.txt for details.</p>
<p>The root directory contains a directory for each class:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">dir_ls</span>(flowers_root)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/tomasz/.keras/datasets/flower_photos/LICENSE.txt
/home/tomasz/.keras/datasets/flower_photos/daisy
/home/tomasz/.keras/datasets/flower_photos/dandelion
/home/tomasz/.keras/datasets/flower_photos/roses
/home/tomasz/.keras/datasets/flower_photos/sunflowers
/home/tomasz/.keras/datasets/flower_photos/tulips</code></pre>
</div>
</div>
<p>The files in each class directory are examples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>list_ds <span class="ot">&lt;-</span> <span class="fu">file_list_dataset</span>(fs<span class="sc">::</span><span class="fu">path</span>(flowers_root, <span class="st">"*"</span>, <span class="st">"*"</span>))</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>list_ds <span class="sc">%&gt;%</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'/home/tomasz/.keras/datasets/flower_photos/roses/488849503_63a290a8c2_m.jpg'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'/home/tomasz/.keras/datasets/flower_photos/tulips/16765283686_0315ae00a8.jpg'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'/home/tomasz/.keras/datasets/flower_photos/dandelion/17649230811_9bdbbacb8c.jpg'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'/home/tomasz/.keras/datasets/flower_photos/dandelion/4572738670_4787a11058_n.jpg'&gt;
 $ :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'/home/tomasz/.keras/datasets/flower_photos/tulips/18378581986_5cd1494d08_n.jpg'&gt;</code></pre>
</div>
</div>
<p>Read the data using the <code>tf$io$read_file</code> function and extract the label from the path, returning <code>(image, label)</code> pairs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>process_path <span class="ot">&lt;-</span> <span class="cf">function</span>(file_path) {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> tf<span class="sc">$</span>strings<span class="sc">$</span><span class="fu">split</span>(file_path, <span class="st">"/"</span>)[<span class="sc">-</span><span class="dv">2</span>]</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">read_file</span>(file_path), </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    label</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>labeled_ds <span class="ot">&lt;-</span> list_ds <span class="sc">%&gt;%</span> </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(process_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Negative numbers are interpreted python-style when subsetting tensorflow tensors.
See: ?`[.tensorflow.tensor` for details.
To turn off this warning, set `options(tensorflow.extract.warn_negatives_pythonic = FALSE)`</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>el <span class="ot">&lt;-</span> labeled_ds <span class="sc">%&gt;%</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>()</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>el[[<span class="dv">1</span>]]<span class="sc">$</span>shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorShape([])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>el[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(b'sunflowers', shape=(), dtype=string)</code></pre>
</div>
</div>
<!--
TODO(mrry): Add this section.

### Handling text data with unusual sizes

-->
</section>
</section>
<section id="batching-dataset-elements" class="level2">
<h2 class="anchored" data-anchor-id="batching-dataset-elements">Batching dataset elements</h2>
<section id="simple-batching" class="level3">
<h3 class="anchored" data-anchor-id="simple-batching">Simple batching</h3>
<p>The simplest form of batching stacks <code>n</code> consecutive elements of a dataset into a single element. The <code>dataset_batch()</code> transformation does exactly this, with the same constraints as the <code>tf$stack()</code> operator, applied to each component of the elements: ie. for each component <em>i</em>, all elements must have a tensor of the exact same shape.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>inc_dataset <span class="ot">&lt;-</span> <span class="fu">range_dataset</span>(<span class="at">to =</span> <span class="dv">100</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>dec_dataset <span class="ot">&lt;-</span> <span class="fu">range_dataset</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">100</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(inc_dataset, dec_dataset)</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>batched_dataset <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">4</span>)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>batched_dataset <span class="sc">%&gt;%</span> </span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ :List of 2
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([0, 1, 2, 3])&gt;
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([ 0, -1, -2, -3])&gt;
 $ :List of 2
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([4, 5, 6, 7])&gt;
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([-4, -5, -6, -7])&gt;
 $ :List of 2
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([ 8,  9, 10, 11])&gt;
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([ -8,  -9, -10, -11])&gt;
 $ :List of 2
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([12, 13, 14, 15])&gt;
  ..$ :&lt;tf.Tensor: shape=(4), dtype=int64, numpy=array([-12, -13, -14, -15])&gt;</code></pre>
</div>
</div>
<p>While tfdatasets tries to propagate shape information, the default settings of <code>dataset_batch</code> result in an unknown batch size because the last batch may not be full. Note the <code>NULL</code>s in the shape:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>batched_dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.int64, name=None), TensorSpec(shape=(None,), dtype=tf.int64, name=None))&gt;</code></pre>
</div>
</div>
<p>Use the <code>drop_remainder</code> argument to ignore that last batch, and get full shape propagation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>batched_dataset <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> <span class="fu">dataset_batch</span>(<span class="dv">7</span>, <span class="at">drop_remainder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>batched_dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BatchDataset element_spec=(TensorSpec(shape=(7,), dtype=tf.int64, name=None), TensorSpec(shape=(7,), dtype=tf.int64, name=None))&gt;</code></pre>
</div>
</div>
</section>
<section id="batching-tensors-with-padding" class="level3">
<h3 class="anchored" data-anchor-id="batching-tensors-with-padding">Batching tensors with padding</h3>
<p>The above recipe works for tensors that all have the same size. However, many models (e.g.&nbsp;sequence models) work with input data that can have varying size (e.g.&nbsp;sequences of different lengths). To handle this case, the <code>dataset_padded_batch()</code> transformation enables you to batch tensors of different shape by specifying one or more dimensions in which they may be padded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">range_dataset</span>(<span class="at">to =</span> <span class="dv">100</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(x) tf<span class="sc">$</span><span class="fu">fill</span>(<span class="fu">list</span>(tf<span class="sc">$</span><span class="fu">cast</span>(x, tf<span class="sc">$</span>int32)), x)) <span class="sc">%&gt;%</span> </span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_padded_batch</span>(<span class="dv">4</span>, <span class="at">padded_shapes =</span> <span class="fu">shape</span>(<span class="cn">NULL</span>))</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>dataset <span class="sc">%&gt;%</span> </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ :&lt;tf.Tensor: shape=(4, 3), dtype=int64, numpy=…&gt;
 $ :&lt;tf.Tensor: shape=(4, 7), dtype=int64, numpy=…&gt;</code></pre>
</div>
</div>
<p>The <code>dataset_padded_batch()</code> transformation allows you to set different padding for each dimension of each component, and it may be variable-length (signified by <code>NULL</code> in the example above) or constant-length. It is also possible to override the padding value, which defaults to 0.</p>
<!--
TODO(mrry): Add this section.

### Dense ragged -> tf$SparseTensor

-->
</section>
</section>
<section id="training-workflows" class="level2">
<h2 class="anchored" data-anchor-id="training-workflows">Training workflows</h2>
<section id="processing-multiple-epochs" class="level3">
<h3 class="anchored" data-anchor-id="processing-multiple-epochs">Processing multiple epochs</h3>
<p>The tfdatasets API offers two main ways to process multiple epochs of the same data.</p>
<p>The simplest way to iterate over a dataset in multiple epochs is to use the <code>dataset_repeat()</code> transformation. First, create a dataset of titanic data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>titanic_file <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"train.csv"</span>, </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://storage.googleapis.com/tf-datasets/titanic/train.csv"</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>titanic_lines <span class="ot">&lt;-</span> <span class="fu">text_line_dataset</span>(titanic_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>plot_batch_sizes <span class="ot">&lt;-</span> <span class="cf">function</span>(ds) {    </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  batch_sizes <span class="ot">&lt;-</span> ds <span class="sc">%&gt;%</span> </span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(x) <span class="fu">as.numeric</span>(x<span class="sc">$</span>shape[<span class="dv">1</span>]))</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">seq_along</span>(batch_sizes), batch_sizes)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Applying the <code>dataset_repeat()</code> transformation with no arguments will repeat the input indefinitely.</p>
<p>The <code>dataset_repeat()</code> transformation concatenates its arguments without signaling the end of one epoch and the beginning of the next epoch. Because of this a <code>dataset_batch()</code> applied after <code>dataset_repeat()</code> will yield batches that straddle epoch boundaries:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>titanic_batches <span class="ot">&lt;-</span> titanic_lines <span class="sc">%&gt;%</span> </span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_repeat</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">128</span>)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_batch_sizes</span>(titanic_batches)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If you need clear epoch separation, put <code>dataset_batch()</code> before the repeat:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>titanic_batches <span class="ot">&lt;-</span> titanic_lines <span class="sc">%&gt;%</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">128</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_repeat</span>(<span class="dv">3</span>)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_batch_sizes</span>(titanic_batches)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If you would like to perform a custom computation (e.g.&nbsp;to collect statistics) at the end of each epoch then it’s simplest to restart the dataset iteration on each epoch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> titanic_lines <span class="sc">%&gt;%</span> </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">128</span>)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(epoch <span class="cf">in</span> <span class="fu">seq_len</span>(epochs)) {</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">loop</span>(<span class="cf">for</span>(batch <span class="cf">in</span> dataset) {</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(batch<span class="sc">$</span>shape)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"End of epoch "</span>, epoch, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorShape([128])
TensorShape([128])
TensorShape([128])
TensorShape([128])
TensorShape([116])
End of epoch  1 
TensorShape([128])
TensorShape([128])
TensorShape([128])
TensorShape([128])
TensorShape([116])
End of epoch  2 
TensorShape([128])
TensorShape([128])
TensorShape([128])
TensorShape([128])
TensorShape([116])
End of epoch  3 </code></pre>
</div>
</div>
</section>
<section id="randomly-shuffling-input-data" class="level3">
<h3 class="anchored" data-anchor-id="randomly-shuffling-input-data">Randomly shuffling input data</h3>
<p>The <code>dataset_shuffle()</code> transformation maintains a fixed-size buffer and chooses the next element uniformly at random from that buffer.</p>
<p>Note: While large buffer_sizes shuffle more thoroughly, they can take a lot of memory, and significant time to fill. Consider using <code>dataset_interleave()</code> across files if this becomes a problem.</p>
<p>Add an index to the dataset so you can see the effect:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">text_line_dataset</span>(titanic_file)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>counter <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">Counter</span>()</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(counter, lines)</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_shuffle</span>(<span class="at">buffer_size =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">20</span>)</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.int64, name=None), TensorSpec(shape=(None,), dtype=tf.string, name=None))&gt;</code></pre>
</div>
</div>
<p>Since the <code>buffer_size</code> is 100, and the batch size is 20, the first batch contains no elements with an index over 120.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>line_batch <span class="ot">&lt;-</span> coro<span class="sc">::</span><span class="fu">collect</span>(dataset, <span class="dv">1</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>line_batch[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(
[ 48  59  18  26  94  88  60  10   8  98   2   6  82  41  90  39 105  83
  71  46], shape=(20), dtype=int64)</code></pre>
</div>
</div>
<p>As with <code>dataset_batch()</code> the order relative to <code>dataset_repeat()</code> matters.</p>
<p><code>dataset_shuffle()</code> doesn’t signal the end of an epoch until the shuffle buffer is empty. So a shuffle placed before a repeat will show every element of one epoch before moving to the next:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(counter, lines)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>shuffled <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_shuffle</span>(<span class="at">buffer_size =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_repeat</span>(<span class="dv">2</span>)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Here are the item ID's near the epoch boundary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Here are the item ID's near the epoch boundary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>shuffled <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_skip</span>(<span class="dv">60</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(x) x[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
tf.Tensor([602 582 600 178 612 488 573 568 611 596], shape=(10), dtype=int64)

[[2]]
tf.Tensor([520 382 620 562 441 606 550 539 575 625], shape=(10), dtype=int64)

[[3]]
tf.Tensor([ 57 403 545 579 610 531 623 614], shape=(8), dtype=int64)

[[4]]
tf.Tensor([55 90 79 16 34 82 44 22 35 89], shape=(10), dtype=int64)

[[5]]
tf.Tensor([ 66  36 102 100  76  70 115  91  30  98], shape=(10), dtype=int64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>shuffle_repeat <span class="ot">&lt;-</span> shuffled <span class="sc">%&gt;%</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">as.numeric</span>(x[[<span class="dv">1</span>]])))</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(shuffle_repeat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>But a repeat before a shuffle mixes the epoch boundaries together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(counter, lines)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>shuffled <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_repeat</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_shuffle</span>(<span class="at">buffer_size =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">10</span>)</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Here are the item ID's near the epoch boundary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Here are the item ID's near the epoch boundary:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>shuffled <span class="sc">%&gt;%</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_skip</span>(<span class="dv">55</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(x) x[[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> </span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 15
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([621, 495,  13, 554, 620,  23, 494, 372, 579,   9])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([ 31, 556, 538, 329, 623,   6,  35, 599, 622, 379])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([ 32, 625, 613,  40,  43, 614, 481, 478,  26,  44])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([596, 459, 518,  27, 590, 584,  47, 514, 557, 578])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([ 24, 597,  55,  61, 568,  22, 510, 575,  18,  12])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([581, 612,  41, 386,  25,  36, 526,  14,  73, 619])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([  3,  17, 517,  48,  58,  70,  56,  72,  52,   1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([506,  74,  53,  37,  87,  49,  86,  78,  15,  33])&gt;
  [list output truncated]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>repeat_shuffle <span class="ot">&lt;-</span> shuffled <span class="sc">%&gt;%</span> </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">as.numeric</span>(x[[<span class="dv">1</span>]])))</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(repeat_shuffle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="preprocessing-data" class="level2">
<h2 class="anchored" data-anchor-id="preprocessing-data">Preprocessing data</h2>
<p>The <code>dataset_map(f)</code> transformation produces a new dataset by applying a given function <code>f</code> to each element of the input dataset. It is based on the <a href="https://en.wikipedia.org/wiki/Map_(higher-order_function)"><code>map()</code></a> function that is commonly applied to lists (and other structures) in functional programming languages. The function <code>f</code> takes the <code>tf$Tensor</code> objects that represent a single element in the input, and returns the <code>tf$Tensor</code> objects that will represent a single element in the new dataset. Its implementation uses standard TensorFlow operations to transform one element into another.</p>
<p>This section covers common examples of how to use <code>dataset_map()</code>.</p>
<section id="decoding-image-data-and-resizing-it" class="level3">
<h3 class="anchored" data-anchor-id="decoding-image-data-and-resizing-it">Decoding image data and resizing it</h3>
<!-- TODO(markdaoust): link to image augmentation when it exists -->
<p>When training a neural network on real-world image data, it is often necessary to convert images of different sizes to a common size, so that they may be batched into a fixed size.</p>
<p>Rebuild the flower filenames dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>list_ds <span class="ot">&lt;-</span> <span class="fu">file_list_dataset</span>(<span class="fu">file.path</span>(flowers_root, <span class="st">"*"</span>, <span class="st">"*"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Write a function that manipulates the dataset elements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reads an image from a file, decodes it into a dense tensor, and resizes it</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to a fixed shape.</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>parse_image <span class="ot">&lt;-</span> <span class="cf">function</span>(filename) {</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  parts <span class="ot">&lt;-</span> tf<span class="sc">$</span>strings<span class="sc">$</span><span class="fu">split</span>(filename, <span class="st">"/"</span>)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> parts[<span class="sc">-</span><span class="dv">2</span>]</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">read_file</span>(filename)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">decode_jpeg</span>(image)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> tf<span class="sc">$</span>image<span class="sc">$</span><span class="fu">convert_image_dtype</span>(image, tf<span class="sc">$</span>float32)</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  image <span class="ot">&lt;-</span> tf<span class="sc">$</span>image<span class="sc">$</span><span class="fu">resize</span>(image, <span class="fu">shape</span>(<span class="dv">128</span>, <span class="dv">128</span>))</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(image, label)</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Test that it works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>parsed <span class="ot">&lt;-</span> list_ds <span class="sc">%&gt;%</span> </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">iter_next</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_image</span>()</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>show <span class="ot">&lt;-</span> <span class="cf">function</span>(parsed, <span class="at">maxcolor=</span><span class="dv">1</span>) {  </span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="fu">as.raster</span>(<span class="fu">as.array</span>(parsed[[<span class="dv">1</span>]]), <span class="at">max =</span> maxcolor))</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">title</span>(<span class="fu">as.character</span>(parsed[[<span class="dv">2</span>]]))</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(parsed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Map it over the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>images_ds <span class="ot">&lt;-</span> list_ds <span class="sc">%&gt;%</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(parse_image)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>images_ds <span class="sc">%&gt;%</span> </span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(show)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-64-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
NULL

[[2]]
NULL</code></pre>
</div>
</div>
<!-- ### Applying arbitrary Python logic -->
<!-- For performance reasons, use TensorFlow operations for -->
<!-- preprocessing your data whenever possible. However, it is sometimes useful to -->
<!-- call external Python libraries when parsing your input data. You can use the `tf$py_function()` operation in a `dataset_map()` transformation. -->
<!-- For example, if you want to apply a random rotation, the `tf$image` module only has `tf$image$rot90`, which is not very useful for image augmentation.  -->
<!-- Note: `tensorflow_addons` has a TensorFlow compatible `rotate` in `tensorflow_addons$image$rotate`. -->
<!-- To demonstrate `tf$py_function`, try using the `scipy$ndimage$rotate` function instead: -->
<!-- ```{r} -->
<!-- import scipy$ndimage as ndimage -->
<!-- random_rotate_image <- function(image) {    } -->
<!--   image <- ndimage$rotate(image, np$random$uniform(-30, 30), reshape = FALSE) -->
<!--   return image -->
<!-- ``` -->
<!-- ```{r} -->
<!-- image, label = next(iter(images_ds)) -->
<!-- image <- random_rotate_image(image) -->
<!-- show(image, label) -->
<!-- ``` -->
<!-- To use this function with `dataset_map` the same caveats apply as with `dataset_from_generator`, you need to describe the return shapes and types when you apply the function: -->
<!-- ```{r} -->
<!-- tf_random_rotate_image <- function(image, label) {    } -->
<!--   im_shape <- image$shape -->
<!--   [image,] <- tf$py_function(random_rotate_image, [image], [tf$float32]) -->
<!--   image$set_shape(im_shape) -->
<!--   return image, label -->
<!-- ``` -->
<!-- ```{r} -->
<!-- rot_ds <- images_ds$map(tf_random_rotate_image) -->
<!-- for image, label in rot_ds$take(2): -->
<!--   show(image, label) -->
<!-- ``` -->
</section>
<section id="parsing-tfexample-protocol-buffer-messages" class="level3">
<h3 class="anchored" data-anchor-id="parsing-tfexample-protocol-buffer-messages">Parsing <code>tf$Example</code> protocol buffer messages</h3>
<p>Many input pipelines extract <code>tf$train$Example</code> protocol buffer messages from a TFRecord format. Each <code>tf$train$Example</code> record contains one or more “features”, and the input pipeline typically converts these features into tensors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>fsns_test_file <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fsns.tfrec"</span>, </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://storage.googleapis.com/download.tensorflow.org/data/fsns-20160927/testdata/fsns-00000-of-00001"</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>dataset <span class="ot">&lt;-</span> <span class="fu">tfrecord_dataset</span>(<span class="at">filenames =</span> fsns_test_file)</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;TFRecordDatasetV2 element_spec=TensorSpec(shape=(), dtype=tf.string, name=None)&gt;</code></pre>
</div>
</div>
<p>You can work with <code>tf$train$Example</code> protos outside of a <code>tf$data$Dataset</code> to understand the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>raw_example <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> reticulate<span class="sc">::</span><span class="fu">iter_next</span>()</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>parsed <span class="ot">&lt;-</span> tf<span class="sc">$</span>train<span class="sc">$</span>Example<span class="sc">$</span><span class="fu">FromString</span>(raw_example<span class="sc">$</span><span class="fu">numpy</span>())</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>feature <span class="ot">&lt;-</span> parsed<span class="sc">$</span>features<span class="sc">$</span>feature</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>raw_img <span class="ot">&lt;-</span> feature[<span class="st">'image/encoded'</span>]<span class="sc">$</span>bytes_list<span class="sc">$</span>value[<span class="dv">0</span>]</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>img <span class="ot">&lt;-</span> tf<span class="sc">$</span>image<span class="sc">$</span><span class="fu">decode_png</span>(raw_img)</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>img <span class="sc">%&gt;%</span> </span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.array</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.raster</span>(<span class="at">max =</span> <span class="dv">255</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>raw_example <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>() <span class="sc">%&gt;%</span> reticulate<span class="sc">::</span><span class="fu">iter_next</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>tf_parse <span class="ot">&lt;-</span> <span class="cf">function</span>(eg) {</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  example <span class="ot">&lt;-</span> tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">parse_example</span>(</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>      eg[tf<span class="sc">$</span>newaxis], </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>      reticulate<span class="sc">::</span><span class="fu">dict</span>(</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'image/encoded'</span> <span class="ot">=</span> tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">FixedLenFeature</span>(<span class="at">shape =</span> <span class="fu">shape</span>(), <span class="at">dtype =</span> tf<span class="sc">$</span>string),</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'image/text'</span> <span class="ot">=</span> tf<span class="sc">$</span>io<span class="sc">$</span><span class="fu">FixedLenFeature</span>(<span class="at">shape =</span> <span class="fu">shape</span>(), <span class="at">dtype =</span> tf<span class="sc">$</span>string)</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">list</span>(example[[<span class="st">'image/encoded'</span>]][<span class="dv">1</span>], example[[<span class="st">'image/text'</span>]][<span class="dv">1</span>])</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> tf<span class="sc">$</span>image<span class="sc">$</span><span class="fu">decode_png</span>(out[[<span class="dv">1</span>]])</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>example <span class="ot">&lt;-</span> <span class="fu">tf_parse</span>(raw_example)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">as.character</span>(example[[<span class="dv">2</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Rue Perreyon"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(example, <span class="at">maxcolor =</span> <span class="dv">255</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>decoded <span class="ot">&lt;-</span> dataset <span class="sc">%&gt;%</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(tf_parse)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>decoded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;MapDataset element_spec=(TensorSpec(shape=(None, None, None), dtype=tf.uint8, name=None), TensorSpec(shape=(), dtype=tf.string, name=None))&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>decoded <span class="sc">%&gt;%</span> </span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ :List of 2
  ..$ :&lt;tf.Tensor: shape=(10, 150, 600, 3), dtype=uint8, numpy=…&gt;
  ..$ :&lt;tf.Tensor: shape=(10), dtype=string, numpy=…&gt;</code></pre>
</div>
</div>
</section>
<section id="time-series-windowing" class="level3">
<h3 class="anchored" data-anchor-id="time-series-windowing">Time series windowing</h3>
<p>For an end to end time series example see: <a href="../../tutorials/structured_data/time_series.qmd">Time series forecasting</a>. Time series data is often organized with the time axis intact. Use a simple <code>range_dataset()</code> to demonstrate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>range_ds <span class="ot">&lt;-</span> <span class="fu">range_dataset</span>(<span class="at">to =</span> <span class="dv">100000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Typically, models based on this sort of data will want a contiguous time slice. The simplest approach would be to batch the data:</p>
<section id="using-batch" class="level4">
<h4 class="anchored" data-anchor-id="using-batch">Using <code>batch</code></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>batches <span class="ot">&lt;-</span> range_ds <span class="sc">%&gt;%</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">10</span>, <span class="at">drop_remainder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>batches <span class="sc">%&gt;%</span> coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([10, 11, 12, 13, 14, 15, 16, 17, 18, 19])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([20, 21, 22, 23, 24, 25, 26, 27, 28, 29])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([30, 31, 32, 33, 34, 35, 36, 37, 38, 39])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([40, 41, 42, 43, 44, 45, 46, 47, 48, 49])&gt;</code></pre>
</div>
</div>
<p>Or to make dense predictions one step into the future, you might shift the features and labels by one step relative to each other:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>dense_1_step <span class="ot">&lt;-</span> <span class="cf">function</span>(batch) {</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Shift features and labels one step relative to each other.</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(batch[<span class="cn">NULL</span><span class="sc">:-</span><span class="dv">1</span>], batch[<span class="dv">2</span><span class="sc">:</span><span class="cn">NULL</span>])</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>predict_dense_1_step <span class="ot">&lt;-</span> batches <span class="sc">%&gt;%</span> <span class="fu">dataset_map</span>(dense_1_step)</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>predict_dense_1_step <span class="sc">%&gt;%</span> </span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]][[1]]
tf.Tensor([0 1 2 3 4 5 6 7 8 9], shape=(10), dtype=int64)

[[1]][[2]]
tf.Tensor([1 2 3 4 5 6 7 8 9], shape=(9), dtype=int64)


[[2]]
[[2]][[1]]
tf.Tensor([10 11 12 13 14 15 16 17 18 19], shape=(10), dtype=int64)

[[2]][[2]]
tf.Tensor([11 12 13 14 15 16 17 18 19], shape=(9), dtype=int64)


[[3]]
[[3]][[1]]
tf.Tensor([20 21 22 23 24 25 26 27 28 29], shape=(10), dtype=int64)

[[3]][[2]]
tf.Tensor([21 22 23 24 25 26 27 28 29], shape=(9), dtype=int64)</code></pre>
</div>
</div>
<p>To predict a whole window instead of a fixed offset you can split the batches into two parts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>batches <span class="ot">&lt;-</span> range_ds <span class="sc">%&gt;%</span> </span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">15</span>, <span class="at">drop_remainder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>label_next_5_steps <span class="ot">&lt;-</span> <span class="cf">function</span>(batch) {</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">list</span>(</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>   batch[<span class="cn">NULL</span><span class="sc">:-</span><span class="dv">6</span>],<span class="co"># Inputs: All except the last 5 steps</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>   batch[<span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="cn">NULL</span>] <span class="co"># Labels: The last 5 steps</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a> )   </span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>predict_5_steps <span class="ot">&lt;-</span> batches <span class="sc">%&gt;%</span> <span class="fu">dataset_map</span>(label_next_5_steps)</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>predict_5_steps <span class="sc">%&gt;%</span> coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]][[1]]
tf.Tensor([0 1 2 3 4 5 6 7 8 9], shape=(10), dtype=int64)

[[1]][[2]]
tf.Tensor([10 11 12 13 14], shape=(5), dtype=int64)


[[2]]
[[2]][[1]]
tf.Tensor([15 16 17 18 19 20 21 22 23 24], shape=(10), dtype=int64)

[[2]][[2]]
tf.Tensor([25 26 27 28 29], shape=(5), dtype=int64)


[[3]]
[[3]][[1]]
tf.Tensor([30 31 32 33 34 35 36 37 38 39], shape=(10), dtype=int64)

[[3]][[2]]
tf.Tensor([40 41 42 43 44], shape=(5), dtype=int64)</code></pre>
</div>
</div>
<p>To allow some overlap between the features of one batch and the labels of another, use <code>zip_datasets()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>feature_length <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>label_length <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> range_ds <span class="sc">%&gt;%</span> </span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(feature_length, <span class="at">drop_remainder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> range_ds <span class="sc">%&gt;%</span> </span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(feature_length) <span class="sc">%&gt;%</span> </span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_skip</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(labels) labels[<span class="cn">NULL</span><span class="sc">:</span>label_length])</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>predicted_steps <span class="ot">&lt;-</span> <span class="fu">zip_datasets</span>(features, labels)</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>coro<span class="sc">::</span><span class="fu">collect</span>(predicted_steps, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]][[1]]
tf.Tensor([0 1 2 3 4 5 6 7 8 9], shape=(10), dtype=int64)

[[1]][[2]]
tf.Tensor([10 11 12], shape=(3), dtype=int64)


[[2]]
[[2]][[1]]
tf.Tensor([10 11 12 13 14 15 16 17 18 19], shape=(10), dtype=int64)

[[2]][[2]]
tf.Tensor([20 21 22], shape=(3), dtype=int64)


[[3]]
[[3]][[1]]
tf.Tensor([20 21 22 23 24 25 26 27 28 29], shape=(10), dtype=int64)

[[3]][[2]]
tf.Tensor([30 31 32], shape=(3), dtype=int64)


[[4]]
[[4]][[1]]
tf.Tensor([30 31 32 33 34 35 36 37 38 39], shape=(10), dtype=int64)

[[4]][[2]]
tf.Tensor([40 41 42], shape=(3), dtype=int64)


[[5]]
[[5]][[1]]
tf.Tensor([40 41 42 43 44 45 46 47 48 49], shape=(10), dtype=int64)

[[5]][[2]]
tf.Tensor([50 51 52], shape=(3), dtype=int64)</code></pre>
</div>
</div>
</section>
<section id="using-window" class="level4">
<h4 class="anchored" data-anchor-id="using-window">Using <code>window</code></h4>
<p>While using <code>dataset_batch</code> works, there are situations where you may need finer control. The <code>dataset_window()</code> method gives you complete control, but requires some care: it returns a <code>Dataset</code> of <code>Datasets</code>. See <a href="#dataset_structure">Dataset structure</a> for details.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>window_size <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>windows <span class="ot">&lt;-</span> range_ds <span class="sc">%&gt;%</span> </span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_window</span>(window_size, <span class="at">shift =</span> <span class="dv">1</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>coro<span class="sc">::</span><span class="fu">collect</span>(windows, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;

[[2]]
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;

[[3]]
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;

[[4]]
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;

[[5]]
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;</code></pre>
</div>
</div>
<p>The <code>dataset_flat_map</code> method can take a dataset of datasets and flatten it into a single dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>windows <span class="sc">%&gt;%</span> </span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_flat_map</span>(<span class="cf">function</span>(x) x) <span class="sc">%&gt;%</span> </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">30</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
tf.Tensor(0, shape=(), dtype=int64)

[[2]]
tf.Tensor(1, shape=(), dtype=int64)

[[3]]
tf.Tensor(2, shape=(), dtype=int64)

[[4]]
tf.Tensor(3, shape=(), dtype=int64)

[[5]]
tf.Tensor(4, shape=(), dtype=int64)

[[6]]
tf.Tensor(1, shape=(), dtype=int64)

[[7]]
tf.Tensor(2, shape=(), dtype=int64)

[[8]]
tf.Tensor(3, shape=(), dtype=int64)

[[9]]
tf.Tensor(4, shape=(), dtype=int64)

[[10]]
tf.Tensor(5, shape=(), dtype=int64)

[[11]]
tf.Tensor(2, shape=(), dtype=int64)

[[12]]
tf.Tensor(3, shape=(), dtype=int64)

[[13]]
tf.Tensor(4, shape=(), dtype=int64)

[[14]]
tf.Tensor(5, shape=(), dtype=int64)

[[15]]
tf.Tensor(6, shape=(), dtype=int64)

[[16]]
tf.Tensor(3, shape=(), dtype=int64)

[[17]]
tf.Tensor(4, shape=(), dtype=int64)

[[18]]
tf.Tensor(5, shape=(), dtype=int64)

[[19]]
tf.Tensor(6, shape=(), dtype=int64)

[[20]]
tf.Tensor(7, shape=(), dtype=int64)

[[21]]
tf.Tensor(4, shape=(), dtype=int64)

[[22]]
tf.Tensor(5, shape=(), dtype=int64)

[[23]]
tf.Tensor(6, shape=(), dtype=int64)

[[24]]
tf.Tensor(7, shape=(), dtype=int64)

[[25]]
tf.Tensor(8, shape=(), dtype=int64)

[[26]]
tf.Tensor(5, shape=(), dtype=int64)

[[27]]
tf.Tensor(6, shape=(), dtype=int64)

[[28]]
tf.Tensor(7, shape=(), dtype=int64)

[[29]]
tf.Tensor(8, shape=(), dtype=int64)

[[30]]
tf.Tensor(9, shape=(), dtype=int64)</code></pre>
</div>
</div>
<p>In nearly all cases, you will want to <code>.batch</code> the dataset first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>sub_to_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(sub) {</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  sub <span class="sc">%&gt;%</span> </span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_batch</span>(window_size, <span class="at">drop_remainder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>windows <span class="sc">%&gt;%</span> </span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_flat_map</span>(sub_to_batch) <span class="sc">%&gt;%</span> </span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
tf.Tensor([0 1 2 3 4], shape=(5), dtype=int64)

[[2]]
tf.Tensor([1 2 3 4 5], shape=(5), dtype=int64)

[[3]]
tf.Tensor([2 3 4 5 6], shape=(5), dtype=int64)

[[4]]
tf.Tensor([3 4 5 6 7], shape=(5), dtype=int64)

[[5]]
tf.Tensor([4 5 6 7 8], shape=(5), dtype=int64)</code></pre>
</div>
</div>
<p>Now, you can see that the <code>shift</code> argument controls how much each window moves over. Putting this together you might write this function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>make_window_dataset <span class="ot">&lt;-</span> <span class="cf">function</span>(ds, <span class="at">window_size =</span> <span class="dv">5</span>, <span class="at">shift =</span> <span class="dv">1</span>, <span class="at">stride =</span> <span class="dv">1</span>) {</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  windows <span class="ot">&lt;-</span> ds <span class="sc">%&gt;%</span> </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_window</span>(window_size, <span class="at">shift =</span> shift, <span class="at">stride =</span> stride)</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  sub_to_batch <span class="ot">&lt;-</span> <span class="cf">function</span>(sub) {</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    sub <span class="sc">%&gt;%</span> </span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dataset_batch</span>(window_size, <span class="at">drop_remainder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>  windows <span class="sc">%&gt;%</span> </span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dataset_flat_map</span>(sub_to_batch)</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">&lt;-</span> <span class="fu">make_window_dataset</span>(range_ds, <span class="at">window_size =</span> <span class="dv">10</span>, <span class="at">shift =</span> <span class="dv">5</span>, <span class="at">stride =</span> <span class="dv">3</span>)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>coro<span class="sc">::</span><span class="fu">collect</span>(ds, <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([ 0,  3,  6,  9, 12, 15, 18, 21, 24, 27])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([ 5,  8, 11, 14, 17, 20, 23, 26, 29, 32])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([10, 13, 16, 19, 22, 25, 28, 31, 34, 37])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([15, 18, 21, 24, 27, 30, 33, 36, 39, 42])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([20, 23, 26, 29, 32, 35, 38, 41, 44, 47])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([25, 28, 31, 34, 37, 40, 43, 46, 49, 52])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([30, 33, 36, 39, 42, 45, 48, 51, 54, 57])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([35, 38, 41, 44, 47, 50, 53, 56, 59, 62])&gt;
  [list output truncated]</code></pre>
</div>
</div>
<p>Then it’s easy to extract labels, as before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>dense_labels_ds <span class="ot">&lt;-</span> ds <span class="sc">%&gt;%</span> </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(dense_1_step)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>coro<span class="sc">::</span><span class="fu">collect</span>(dense_labels_ds, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]][[1]]
tf.Tensor([ 0  3  6  9 12 15 18 21 24 27], shape=(10), dtype=int64)

[[1]][[2]]
tf.Tensor([ 3  6  9 12 15 18 21 24 27], shape=(9), dtype=int64)</code></pre>
</div>
</div>
</section>
</section>
<section id="resampling" class="level3">
<h3 class="anchored" data-anchor-id="resampling">Resampling</h3>
<p>When working with a dataset that is very class-imbalanced, you may want to resample the dataset. tfdatasets provides two methods to do this. The credit card fraud dataset is a good example of this sort of problem.</p>
<p>Note: See <a href="../tutorials/keras/imbalanced_data.qmd">Imbalanced Data</a> for a full tutorial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>zip_path <span class="ot">&lt;-</span> <span class="fu">get_file</span>(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin =</span> <span class="st">'https://storage.googleapis.com/download.tensorflow.org/data/creditcard.zip'</span>,</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fname =</span> <span class="st">'creditcard.zip'</span>,</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">extract =</span> <span class="cn">TRUE</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"zip"</span>, <span class="st">"csv"</span>, zip_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>creditcard_ds <span class="ot">&lt;-</span> tf<span class="sc">$</span>data<span class="sc">$</span>experimental<span class="sc">$</span><span class="fu">make_csv_dataset</span>(</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  csv_path, </span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch_size =</span> 1024L, </span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_name =</span> <span class="st">"Class"</span>,</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set the column types: 30 floats and an int.</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_defaults =</span> <span class="fu">c</span>(<span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="dv">30</span>), <span class="cf">function</span>(x) tf<span class="sc">$</span>float32), tf<span class="sc">$</span>int64)</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, check the distribution of classes, it is highly skewed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>count <span class="ot">&lt;-</span> <span class="cf">function</span>(counts, batch) {</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  class_1 <span class="ot">&lt;-</span> batch[[<span class="dv">2</span>]] <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  class_1 <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">cast</span>(class_1, tf<span class="sc">$</span>int32)</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  class_0 <span class="ot">&lt;-</span> batch[[<span class="dv">2</span>]] <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>  class_0 <span class="ot">&lt;-</span> tf<span class="sc">$</span><span class="fu">cast</span>(class_0, tf<span class="sc">$</span>int32)</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>  counts[[<span class="st">'class_0'</span>]] <span class="ot">&lt;-</span> counts[[<span class="st">'class_0'</span>]] <span class="sc">+</span> tf<span class="sc">$</span><span class="fu">reduce_sum</span>(class_0)</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>  counts[[<span class="st">'class_1'</span>]] <span class="ot">&lt;-</span> counts[[<span class="st">'class_1'</span>]] <span class="sc">+</span> tf<span class="sc">$</span><span class="fu">reduce_sum</span>(class_1)</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>  counts</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> creditcard_ds <span class="sc">%&gt;%</span> </span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_take</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_reduce</span>(</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initial_state =</span> <span class="fu">list</span>(<span class="st">'class_0'</span> <span class="ot">=</span> 0L, <span class="st">'class_1'</span> <span class="ot">=</span> 0L),</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">reduce_func =</span> count</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$class_0
tf.Tensor(10192, shape=(), dtype=int32)

$class_1
tf.Tensor(48, shape=(), dtype=int32)</code></pre>
</div>
</div>
<p>A common approach to training with an imbalanced dataset is to balance it. tfdatasets includes a few methods which enable this workflow:</p>
<section id="datasets-sampling" class="level4">
<h4 class="anchored" data-anchor-id="datasets-sampling">Datasets sampling</h4>
<p>One approach to resampling a dataset is to use <code>sample_from_datasets</code>. This is more applicable when you have a separate <code>data$Dataset</code> for each class.</p>
<p>Here, just use filter to generate them from the credit card fraud data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>negative_ds <span class="ot">&lt;-</span> creditcard_ds <span class="sc">%&gt;%</span> </span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_unbatch</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_filter</span>(<span class="cf">function</span>(features, label) label <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_repeat</span>()</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>positive_ds <span class="ot">&lt;-</span> creditcard_ds <span class="sc">%&gt;%</span> </span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_unbatch</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_filter</span>(<span class="cf">function</span>(features, label) label <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_repeat</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>positive_ds <span class="sc">%&gt;%</span> </span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]][[1]]
Dict (30 items)

[[1]][[2]]
tf.Tensor(1, shape=(), dtype=int64)</code></pre>
</div>
</div>
<p>To use <code>sample_from_datasets</code> pass the datasets, and the weight for each:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>balanced_ds <span class="ot">&lt;-</span> <span class="fu">list</span>(negative_ds, positive_ds) <span class="sc">%&gt;%</span> </span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_from_datasets</span>(<span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the dataset produces examples of each class with 50/50 probability:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>balanced_ds <span class="sc">%&gt;%</span> </span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(x, y) y) <span class="sc">%&gt;%</span> </span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 0, 1, 1, 0, 1, 0, 0, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 1, 1, 0, 1, 1, 1, 1, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 0, 0, 1, 1, 0, 0, 1, 0, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 1, 1, 0, 1, 0, 1, 1, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 0, 0, 1, 0, 0, 1, 0, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 0, 0, 0, 0, 0, 1, 0, 1, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 0, 1, 1, 0, 0, 1, 1, 1, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 0, 0, 0, 0, 0, 1, 0, 1])&gt;
  [list output truncated]</code></pre>
</div>
</div>
</section>
<section id="rejection-resampling" class="level4">
<h4 class="anchored" data-anchor-id="rejection-resampling">Rejection resampling</h4>
<p>One problem with the above <code>sample_from_datasets</code> approach is that it needs a separate TensorFlow Dataset per class. You could use <code>dataset_filter</code> to create those two datasets, but that results in all the data being loaded twice.</p>
<p>The <code>dataset_rejection_resample()</code> method can be applied to a dataset to rebalance it, while only loading it once. Elements will be dropped from the dataset to achieve balance.</p>
<p><code>dataset_rejection_resample()</code> takes a <code>class_func</code> argument. This <code>class_func</code> is applied to each dataset element, and is used to determine which class an example belongs to for the purposes of balancing.</p>
<p>The goal here is to balance the lable distribution, and the elements of <code>creditcard_ds</code> are already <code>(features, label)</code> pairs. So the <code>class_func</code> just needs to return those labels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>class_func <span class="ot">&lt;-</span> <span class="cf">function</span>(features, label) { </span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  label</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resampling method deals with individual examples, so in this case you must <code>unbatch</code> the dataset before applying that method.</p>
<p>The method needs a target distribution, and optionally an initial distribution estimate as inputs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>resample_ds <span class="ot">&lt;-</span> creditcard_ds <span class="sc">%&gt;%</span> </span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_unbatch</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_rejection_resample</span>(</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    class_func, </span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_dist =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>),</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">initial_dist =</span> <span class="fu">prop.table</span>(<span class="fu">sapply</span>(counts, as.numeric))</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>dataset_rejection_resample()</code> method returns <code>(class, example)</code> pairs where the <code>class</code> is the output of the <code>class_func</code>. In this case, the <code>example</code> was already a <code>(feature, label)</code> pair, so use <code>map</code> to drop the extra copy of the labels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>balanced_ds <span class="ot">&lt;-</span> resample_ds <span class="sc">%&gt;%</span> </span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(extra_label, features_and_label) features_and_label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the dataset produces examples of each class with 50/50 probability:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>balanced_ds <span class="sc">%&gt;%</span> </span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(<span class="cf">function</span>(feat, label) label) <span class="sc">%&gt;%</span> </span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  coro<span class="sc">::</span><span class="fu">collect</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 10
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 1, 0, 0, 0, 1, 1, 1, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 1, 0, 0, 1, 0, 0, 1, 0, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 1, 1, 0, 1, 1, 0, 0, 1, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 0, 0, 0, 0, 1, 1, 0, 0, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 1, 1, 0, 1, 0, 0, 1, 1, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 0, 0, 1, 0, 1, 0, 0, 1, 0])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([0, 0, 1, 1, 1, 1, 1, 0, 1, 1])&gt;
 $ :&lt;tf.Tensor: shape=(10), dtype=int64, numpy=array([1, 1, 0, 1, 0, 0, 0, 0, 0, 0])&gt;
  [list output truncated]</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="iterator-checkpointing" class="level2">
<h2 class="anchored" data-anchor-id="iterator-checkpointing">Iterator Checkpointing</h2>
<p>Tensorflow supports <a href="https://www.tensorflow.org/guide/checkpoint">taking checkpoints</a> so that when your training process restarts it can restore the latest checkpoint to recover most of its progress. In addition to checkpointing the model variables, you can also checkpoint the progress of the dataset iterator. This could be useful if you have a large dataset and don’t want to start the dataset from the beginning on each restart. Note however that iterator checkpoints may be large, since transformations such as <code>shuffle</code> and <code>prefetch</code> require buffering elements within the iterator.</p>
<p>To include your iterator in a checkpoint, pass the iterator to the <code>tf$train$Checkpoint</code> constructor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>range_ds <span class="ot">&lt;-</span> <span class="fu">range_dataset</span>(<span class="at">to =</span> <span class="dv">20</span>)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>iterator <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">as_iterator</span>(range_ds)</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>ckpt <span class="ot">&lt;-</span> tf<span class="sc">$</span>train<span class="sc">$</span><span class="fu">Checkpoint</span>(<span class="at">step =</span> tf<span class="sc">$</span><span class="fu">Variable</span>(<span class="dv">0</span>), <span class="at">iterator =</span> iterator)</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>manager <span class="ot">&lt;-</span> tf<span class="sc">$</span>train<span class="sc">$</span><span class="fu">CheckpointManager</span>(ckpt, <span class="st">'/tmp/my_ckpt'</span>, <span class="at">max_to_keep =</span> <span class="dv">3</span>)</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(reticulate<span class="sc">::</span><span class="fu">iter_next</span>(iterator))</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(0, shape=(), dtype=int64)
tf.Tensor(1, shape=(), dtype=int64)
tf.Tensor(2, shape=(), dtype=int64)
tf.Tensor(3, shape=(), dtype=int64)
tf.Tensor(4, shape=(), dtype=int64)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>save_path <span class="ot">&lt;-</span> manager<span class="sc">$</span><span class="fu">save</span>()</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(reticulate<span class="sc">::</span><span class="fu">iter_next</span>(iterator))</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(5, shape=(), dtype=int64)
tf.Tensor(6, shape=(), dtype=int64)
tf.Tensor(7, shape=(), dtype=int64)
tf.Tensor(8, shape=(), dtype=int64)
tf.Tensor(9, shape=(), dtype=int64)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>ckpt<span class="sc">$</span><span class="fu">restore</span>(manager<span class="sc">$</span>latest_checkpoint)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;tensorflow.python.training.tracking.util.CheckpointLoadStatus object at 0x7f0e746bd4f0&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(reticulate<span class="sc">::</span><span class="fu">iter_next</span>(iterator))</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tf.Tensor(5, shape=(), dtype=int64)
tf.Tensor(6, shape=(), dtype=int64)
tf.Tensor(7, shape=(), dtype=int64)
tf.Tensor(8, shape=(), dtype=int64)
tf.Tensor(9, shape=(), dtype=int64)</code></pre>
</div>
</div>
<p>Note: It is not possible to checkpoint an iterator which relies on external state such as a <code>tf$py_function</code>. Attempting to do so will raise an exception complaining about the external state.</p>
</section>
<section id="using-tfdatasets-with-keras" class="level2">
<h2 class="anchored" data-anchor-id="using-tfdatasets-with-keras">Using tfdatasets with Keras</h2>
<p>The Keras API simplifies many aspects of creating and executing machine learning models. Its <code>fit()</code> and <code>evaluate()</code> and <code>predict()</code> APIs support datasets as inputs. Here is a quick dataset and model setup:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(train, test) <span class="sc">%&lt;-%</span> <span class="fu">dataset_fashion_mnist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>fmnist_train_ds <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span> </span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tensor_slices_dataset</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_map</span>(unname) <span class="sc">%&gt;%</span> </span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_shuffle</span>(<span class="dv">5000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">32</span>)</span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">keras_model_sequential</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_rescaling</span>(<span class="at">scale =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">255</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="dv">10</span>)</span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">compile</span>(</span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="st">'adam'</span>,</span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss =</span> <span class="fu">loss_sparse_categorical_crossentropy</span>(<span class="at">from_logits =</span> <span class="cn">TRUE</span>), </span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="st">'accuracy'</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Passing a dataset of <code>(feature, label)</code> pairs is all that’s needed for <code>fit()</code> and <code>evaluate()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(fmnist_train_ds, <span class="at">epochs =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you pass an infinite dataset, for example by calling <code>dataset_repeat()</code>, you just need to also pass the <code>steps_per_epoch</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">fit</span>(</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  fmnist_train_ds <span class="sc">%&gt;%</span> <span class="fu">dataset_repeat</span>(), </span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">epochs =</span> <span class="dv">2</span>, </span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps_per_epoch =</span> <span class="dv">20</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For evaluation you can pass the number of evaluation steps:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(fmnist_train_ds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     loss  accuracy 
0.4316357 0.8527667 </code></pre>
</div>
</div>
<p>For long datasets, set the number of steps to evaluate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">%&gt;%</span> <span class="fu">evaluate</span>(</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  fmnist_train_ds <span class="sc">%&gt;%</span> <span class="fu">dataset_repeat</span>(), </span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">steps =</span> <span class="dv">10</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     loss  accuracy 
0.3390861 0.8843750 </code></pre>
</div>
</div>
<p>The labels are not required in when calling <code>Model$predict</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>predict_ds <span class="ot">&lt;-</span> <span class="fu">tensor_slices_dataset</span>(train<span class="sc">$</span>x) <span class="sc">%&gt;%</span> </span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dataset_batch</span>(<span class="dv">32</span>)</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, predict_ds, <span class="at">steps =</span> <span class="dv">10</span>)</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 320  10</code></pre>
</div>
</div>
<p>But the labels are ignored if you do pass a dataset containing them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, fmnist_train_ds, <span class="at">steps =</span> <span class="dv">10</span>)</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 320  10</code></pre>
</div>
</div>
</section>
<section id="environment-details" class="level2">
<h2 class="anchored" data-anchor-id="environment-details">Environment Details</h2>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tensorflow Version
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>tensorflow<span class="sc">::</span><span class="fu">tf_config</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TensorFlow v2.9.1 (~/.virtualenvs/r-tensorflow-site/lib/python3.9/site-packages/tensorflow)
Python v3.9 (~/.virtualenvs/r-tensorflow-site/bin/python)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
R Environment Information
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.2.1 (2022-06-23)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.4 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/libmkl_rt.so

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] keras_2.9.0.9000      tfdatasets_2.9.0.9000 tensorflow_2.9.0.9000

loaded via a namespace (and not attached):
 [1] Rcpp_1.0.9           pillar_1.7.0         compiler_4.2.1      
 [4] base64enc_0.1-3      tools_4.2.1          bit_4.0.4           
 [7] zeallot_0.1.0        digest_0.6.29        tibble_3.1.7        
[10] lifecycle_1.0.1      jsonlite_1.8.0       evaluate_0.15       
[13] lattice_0.20-45      pkgconfig_2.0.3      png_0.1-7           
[16] rlang_1.0.4          Matrix_1.4-1         cli_3.3.0           
[19] parallel_4.2.1       yaml_2.3.5           xfun_0.31           
[22] coro_1.0.2.9000      fastmap_1.1.0        stringr_1.4.0       
[25] knitr_1.39           fs_1.5.2             hms_1.1.1           
[28] generics_0.1.3       htmlwidgets_1.5.4    vctrs_0.4.1         
[31] bit64_4.0.5          rprojroot_2.0.3      grid_4.2.1          
[34] tidyselect_1.1.2     reticulate_1.25-9000 glue_1.6.2          
[37] here_1.0.1           R6_2.5.1             fansi_1.0.3         
[40] vroom_1.5.7          rmarkdown_2.14       tzdb_0.3.0          
[43] purrr_0.3.4          readr_2.1.2          magrittr_2.0.3      
[46] whisker_0.4          ellipsis_0.3.2       tfruns_1.5.0        
[49] htmltools_0.5.2      utf8_1.2.2           stringi_1.7.8       
[52] crayon_1.5.1        </code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Python Environment Information
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system2</span>(reticulate<span class="sc">::</span><span class="fu">py_exe</span>(), <span class="fu">c</span>(<span class="st">"-m pip freeze"</span>), <span class="at">stdout =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">writeLines</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>absl-py==1.1.0
asttokens==2.0.5
astunparse==1.6.3
backcall==0.2.0
beautifulsoup4==4.11.1
cachetools==5.2.0
certifi==2022.6.15
charset-normalizer==2.1.0
decorator==5.1.1
dill==0.3.5.1
etils==0.6.0
executing==0.8.3
filelock==3.7.1
flatbuffers==1.12
gast==0.4.0
gdown==4.5.1
google-auth==2.9.0
google-auth-oauthlib==0.4.6
google-pasta==0.2.0
googleapis-common-protos==1.56.4
grpcio==1.47.0
h5py==3.7.0
idna==3.3
importlib-metadata==4.12.0
importlib-resources==5.8.0
ipython==8.4.0
jedi==0.18.1
keras==2.9.0
Keras-Preprocessing==1.1.2
keras-tuner==1.1.2
kt-legacy==1.0.4
libclang==14.0.1
Markdown==3.3.7
matplotlib-inline==0.1.3
numpy==1.23.1
oauthlib==3.2.0
opt-einsum==3.3.0
packaging==21.3
pandas==1.4.3
parso==0.8.3
pexpect==4.8.0
pickleshare==0.7.5
Pillow==9.2.0
promise==2.3
prompt-toolkit==3.0.30
protobuf==3.19.4
ptyprocess==0.7.0
pure-eval==0.2.2
pyasn1==0.4.8
pyasn1-modules==0.2.8
pydot==1.4.2
Pygments==2.12.0
pyparsing==3.0.9
PySocks==1.7.1
python-dateutil==2.8.2
pytz==2022.1
PyYAML==6.0
requests==2.28.1
requests-oauthlib==1.3.1
rsa==4.8
scipy==1.8.1
six==1.16.0
soupsieve==2.3.2.post1
stack-data==0.3.0
tensorboard==2.9.1
tensorboard-data-server==0.6.1
tensorboard-plugin-wit==1.8.1
tensorflow==2.9.1
tensorflow-datasets==4.6.0
tensorflow-estimator==2.9.0
tensorflow-hub==0.12.0
tensorflow-io-gcs-filesystem==0.26.0
tensorflow-metadata==1.9.0
termcolor==1.1.0
toml==0.10.2
tqdm==4.64.0
traitlets==5.3.0
typing_extensions==4.3.0
urllib3==1.26.10
wcwidth==0.2.5
Werkzeug==2.1.2
wrapt==1.14.1
zipp==3.8.1</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Additional Information
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>TF Devices:
-  PhysicalDevice(name='/physical_device:CPU:0', device_type='CPU') 
-  PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU') 
CPU cores: 12 
Date rendered: 2022-07-14 
Page render time: 22 seconds</code></pre>
</div>
</div>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../guides/tfautograph/index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Autograph</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../guides/deploy/index.html" class="pagination-link">
        <span class="nav-page-text">Deployment</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>